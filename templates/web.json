{

    "Parameters":{
        "ApplicationName":{
            "Type":"String"
        },
        "EnvironmentName":{
            "Type":"String"
        },
        "Certificate":{
            "Type":"String"
        },
        "KeyName":{
            "Description":"Name of an existing EC2 KeyPair to enable SSH access to the instances",
            "Type":"AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription":"must be the name of an existing EC2 KeyPair."
        },
        "ArtifactS3Bucket":{
            "Type":"String"
        },
        "InstanceType":{
            "Description":"The instance type to deploy to",
            "Type":"String",
            "Default":"t2.micro"
        },
        "MinInstanceCount":{
            "Description":"Min instance count",
            "Type":"Number",
            "Default":2
        },
        "MaxInstanceCount":{
            "Description":"max instance count",
            "Type":"Number",
            "Default":4
        },
        "InstanceCount":{
            "Description":"How many instances should the AutoScaling Group contain",
            "Type":"Number",
            "Default":2
        }
    },
    "Mappings":{
        "AWSRegionToAMI":{
            "us-east-1":{
                "AMI":"ami-9be6f38c"
            },
            "us-east-2":{
                "AMI":"ami-38cd975d"
            },
            "us-west-1":{
                "AMI":"ami-25110f45"
            },
            "us-west-2":{
                "AMI":"ami-e251209a"
            },
            "ca-central-1":{
                "AMI":"ami-eb20928f"
            },
            "eu-west-1":{
                "AMI":"ami-c51e3eb6"
            },
            "eu-west-2":{
                "AMI":"ami-bfe0eadb"
            },
            "eu-central-1":{
                "AMI":"ami-211ada4e"
            },
            "ap-southeast-1":{
                "AMI":"ami-4dd6782e"
            },
            "ap-northeast-2":{
                "AMI":"ami-94bb6dfa"
            },
            "ap-northeast-1":{
                "AMI":"ami-9f0c67f8"
            },
            "ap-southeast-2":{
                "AMI":"ami-28cff44b"
            },
            "ap-south-1":{
                "AMI":"ami-9fc7b0f0"
            },
            "sa-east-1":{
                "AMI":"ami-bb40d8d7"
            }
        }
    },
    "Resources":{
        "AutoScalingGroup":{
            "Type":"AWS::AutoScaling::AutoScalingGroup",
            "Properties":{
                "VPCZoneIdentifier":[
                    {
                        "Fn::ImportValue":{
                            "Fn::Sub":"network-${ApplicationName}-${EnvironmentName}-PrivateSubnet1"
                        }
                    },
                    {
                        "Fn::ImportValue":{
                            "Fn::Sub":"network-${ApplicationName}-${EnvironmentName}-PrivateSubnet2"
                        }
                    }
                ],
                "LaunchConfigurationName":{
                    "Ref":"LaunchConfiguration"
                },
                "TargetGroupARNs":[
                    {
                        "Ref":"TargetGroup"
                    }
                ],
                "MinSize":{
                    "Ref":"MinInstanceCount"
                },
                "MaxSize":{
                    "Ref":"MaxInstanceCount"
                },
                "DesiredCapacity":{
                    "Ref":"InstanceCount"
                },
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":{
                            "Fn::Sub":"${ApplicationName}-${EnvironmentName}"
                        },
                        "PropagateAtLaunch":true
                    }
                ]
            },
            "UpdatePolicy":{
                "AutoScalingRollingUpdate":{
                    "MinInstancesInService":1,
                    "MaxBatchSize":1,
                    "PauseTime":"PT15M",
                    "WaitOnResourceSignals":true
                }
            }
        },
        "LaunchConfiguration":{
            "Type":"AWS::AutoScaling::LaunchConfiguration",
            "Properties":{
                "KeyName":{
                    "Ref":"KeyName"
                },
                "ImageId":{
                    "Fn::FindInMap":[
                        "AWSRegionToAMI",
                        {
                            "Ref":"AWS::Region"
                        },
                        "AMI"
                    ]
                },
                "InstanceType":{
                    "Ref":"InstanceType"
                },
                "IamInstanceProfile":{
                    "Ref":"InstanceProfile"
                },
                "SecurityGroups":[
                    {
                        "Ref":"ApplicationSecurityGroup"
                    }
                ],
                "UserData":{
                    "Fn::Base64":{
                        "Fn::Join":[
                            "",
                            [
                                "#!/bin/bash \n",
                                "yum update -y \n",
                                "yum install -y aws-cfn-bootstrap \n",
                                "aws s3 cp --recursive s3://jsonuploader-artifacts/RPMS  . \n",
                                "sudo yum install -y runit-2.1.2-1.el6.x86_64.rpm jsonuploader-0.0.1-1.x86_64.rpm jsonuploader_runit-0.0.3-1.x86_64.rpm \n",
                                "/opt/aws/bin/cfn-init -v --region ${AWS::Region} --stack ${AWS::StackName} --resource LaunchConfiguration \n",
                                "/opt/aws/bin/cfn-signal -e $? ",
                                " --stack ",
                                {
                                    "Ref":"AWS::StackName"
                                },
                                " --resource AutoScalingGroup ",
                                " --region ",
                                {
                                    "Ref":"AWS::Region"
                                },
                                "\n"
                            ]
                        ]
                    }
                }
            }
        },
        "ApplicationSecurityGroup":{
            "Type":"AWS::EC2::SecurityGroup",
            "Properties":{
                "VpcId":{
                    "Fn::ImportValue":{
                        "Fn::Sub":"network-${ApplicationName}-${EnvironmentName}"
                    }
                },
                "GroupDescription":"Controls who can access the application servers",
                "SecurityGroupIngress":[
                    {
                        "SourceSecurityGroupId":{
                            "Ref":"LoadBalancerSecurityGroup"
                        },
                        "IpProtocol":-1
                    },
                    {
                        "CidrIp":{
                            "Fn::ImportValue":{
                                "Fn::Sub":"network-${ApplicationName}-${EnvironmentName}-VpcCIDR"
                            }
                        },
                        "IpProtocol":-1
                    }
                ],
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":{
                            "Fn::Sub":"${ApplicationName}-${EnvironmentName}-ApplicationServers"
                        }
                    }
                ]
            }
        },
        "LoadBalancerSecurityGroup":{
            "Type":"AWS::EC2::SecurityGroup",
            "Properties":{
                "VpcId":{
                    "Fn::ImportValue":{
                        "Fn::Sub":"network-${ApplicationName}-${EnvironmentName}"
                    }
                },
                "GroupDescription":"Controls who can access the load balancer",
                "SecurityGroupIngress":[
                    {
                        "CidrIp":"0.0.0.0/0",
                        "IpProtocol":-1
                    }
                ],
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":{
                            "Fn::Sub":"${ApplicationName}-${EnvironmentName}-LoadBalancers"
                        }
                    }
                ]
            }
        },
        "InstanceRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "Path":"/",
                "RoleName":{
                    "Fn::Sub":"${ApplicationName}-${EnvironmentName}-${AWS::Region}"
                },
                "AssumeRolePolicyDocument":"{\n \"Statement\": [{\n \"Action\": \"sts:AssumeRole\",\n \"Effect\": \"Allow\",\n \"Principal\": { \n \"Service\": \"ec2.amazonaws.com\" \n }\n }]\n}\n",
                "Policies":[
                    {
                        "PolicyName":{
                            "Fn::Sub":"${ApplicationName}-${EnvironmentName}-${AWS::Region}"
                        },
                        "PolicyDocument":{
                            "Fn::Sub":"{\n \"Statement\": [{\n \"Effect\": \"Allow\",\n \"Action\": [\n \"s3:*\"\n ],\n \"Resource\": [ \"*\" ]\n }]\n}\n"
                        }
                    }
                ]
            }
        },
        "InstanceProfile":{
            "Type":"AWS::IAM::InstanceProfile",
            "Properties":{
                "Path":"/",
                "Roles":[
                    {
                        "Ref":"InstanceRole"
                    }
                ]
            }
        },
        "LoadBalancer":{
            "Type":"AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties":{
                "Name":{
                    "Fn::Sub":"${ApplicationName}-${EnvironmentName}"
                },
                "Subnets":[
                    {
                        "Fn::ImportValue":{
                            "Fn::Sub":"network-${ApplicationName}-${EnvironmentName}-PublicSubnet1"
                        }
                    },
                    {
                        "Fn::ImportValue":{
                            "Fn::Sub":"network-${ApplicationName}-${EnvironmentName}-PublicSubnet2"
                        }
                    }
                ],
                "SecurityGroups":[
                    {
                        "Ref":"LoadBalancerSecurityGroup"
                    }
                ],
                "Tags":[
                    {
                        "Key":"Name",
                        "Value":{
                            "Fn::Sub":"${ApplicationName}-${EnvironmentName}"
                        }
                    }
                ]
            }
        },
        "LoadBalancerListener":{
            "Type":"AWS::ElasticLoadBalancingV2::Listener",
            "Properties":{
                "LoadBalancerArn":{
                    "Ref":"LoadBalancer"
                },
                "Certificates":[
                    {
                        "CertificateArn":{
                            "Ref":"Certificate"
                        }
                    }
                ],
                "Port":443,
                "Protocol":"HTTPS",
                "DefaultActions":[
                    {
                        "Type":"forward",
                        "TargetGroupArn":{
                            "Ref":"TargetGroup"
                        }
                    }
                ]
            }
        },
        "TargetGroup":{
            "Type":"AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties":{
                "Name":{
                    "Fn::Sub":"${ApplicationName}-${EnvironmentName}"
                },
                "VpcId":{
                    "Fn::ImportValue":{
                        "Fn::Sub":"network-${ApplicationName}-${EnvironmentName}"
                    }
                },
                "Port":8080,
                "HealthCheckPath":"/status.html",
                "Protocol":"HTTP"
            }
        }
    }

}
